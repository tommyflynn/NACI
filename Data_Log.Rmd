---
title: 'Network Analysis of Clinical Interactions (NACI): Data Cleaning Log'
output:
  pdf_document: default
  html_notebook: default
editor_options:
  chunk_output_type: console
---  

# Setup  

```{r Setup}
# set options
# This is an example setup chunk from the N741 project
knitr::opts_chunk$set(root.dir = "~/Documents/1_Research/2_Data_Science/0_Projects/1_NACI/Data",
                      echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
# options(na.action = na.warn)??

```

```{r Libraries}
# Load packages
# library(igraph) # package for working with and visualizing network analysis objectve
library(haven) # package for importing SAS data files (i.e., ".sas7bdat")
library(tidyverse) # packages for data import, cleaning, transformation, and analysis
library(gt) # package for creating and formating latex tables
library(lubridate) # package for working with date data
# library(pander) # ????
# library(printr) # ????
# library(forcats) # package for making and working with factors
# library(modelr) # package for statistical modeling in r
library(readxl)
library(readr)
library(stringr)
library(labelled)
```

```{r Data Path}
data_path <- paste0(getwd(), "/Data/")
# If you need to change the working directory, use `setwd(data_path)`
# Create a list of all items in the current working directory
files <- list.files(path = data_path)
# Print directory file list
writeLines(files)
```

# Data Import & Cleaning

## pt_complete  
RFID badge location room number for every second of every shift, patients only

```{r ReadData pt_complete}
# ---- `pt_complete` 
# 1a. read "completepat.sas7bdat", 
pt_complete <- 
  read_sas(paste0(data_path, "completepat.sas7bdat"))
```

```{r CleanData pt_complete}
require(lubridate)
# 2a. subset first 10 observations for data transformation code preparation
pt_head <- head(pt_complete) %>% 
  # 3a. Pivot the data.frame from wide to long by placing all column names that start with "floc" into a new column, "seconds," and placing respective observations for each "floc" variable into a "location_num" column
  pivot_longer(cols = starts_with("floc"), names_to = "seconds", values_to = "location_num") %>% 
  # 4a. Remove the prefix "floc" from `time_seconds` and keep the digits as `seconds`
  mutate(seconds = as.integer(str_replace(seconds, "floc", "")), 
         shift_num_ampm = str_trim(shift_num_ampm),
         shift_num = as.integer(str_extract(shift_num_ampm, "[:digit:]+")),
         am_pm = str_extract(shift_num_ampm, "am|pm"),
         date = make_date(year = year, month = mon, day = day)) # %>% 
  # 5. Filter out all rows for which no location was recorded
  # filter(!is.na(location)) %>% 

# View data frame structure
# glimpse(pt_head)
pt_head

```

## staff_complete 
RFID badge location room number for every second of every shift, patients only
  
```{r ReadData staff_complete}
# ---- `staff_complete
# 1b. read "completestaff.sas7bdat"
staff_complete <- 
  read_sas(paste0(data_path, "completestaff.sas7bdat"))
```

```{r CleanData staff_complete}
# 2a. subset first 10 observations for data transformation code preparation
staff_head <- head(staff_complete) %>% 
  # 3a. Pivot the data.frame from wide to long by placing all column names that start with "floc" into a new column, "seconds," and placing respective observations for each "floc" variable into a "location_num" column
  pivot_longer(cols = starts_with("floc"), names_to = "seconds", values_to = "location_num") %>% 
  # 4a. Remove the prefix "floc" from `time_seconds` and keep the digits as `seconds`
  mutate(seconds = as.integer(str_replace(seconds, "floc", "")), 
         shift_num_ampm = str_trim(shift_num_ampm),
         shift_num = as.integer(str_extract(shift_num_ampm, "[:digit:]+")),
         am_pm = str_extract(shift_num_ampm, "am|pm"),
         date = make_date(year = year, month = mon, day = day)) # %>% 
  # 5. Filter out all rows for which no location was recorded
  # filter(!is.na(location)) %>% 
# View data frame structure
# str(staff_head)
# glimpse(staff_head)
staff_head
```



```{r ReadData edge_list}
# ---- 'edge_list` ----
# 1c. read "allshifts_edges.sas7bdat"
edge_list <- read_sas(paste0(data_path, "Data_Files/allshifts_edges.sas7bdat"))
edge_list2 <- read_sas(paste0(data_path, "Data_Files/edges2.sas7bdat"))
```

```{r CleanData edge_list}
# Print the first 6 observations of edge_list
head(edge_list)
# Print out the variable labels for all columns of edge_list
var_label(edge_list)

# Print the first 6 observations of edge_list2
head(edge_list2)
# Print out the variable labels for all columns of edge_list2
var_label(edge_list2)
```

```{r ReadData id_sid}
# 1d. read "id_sid_matchup.sas7bdat" into id_sid and "id_sid_matchup2.sas7bdat" into id_sid2
id_sid <- read_sas(paste0(data_path, "Data_Files/id_sid_matchup.sas7bdat"))
id_sid2 <- read_sas(paste0(data_path, "Data_Files/id_sid_matchup2.sas7bdat"))
```

```{r CleanData id_sid}
# Print the first 6 rows of id_sid
head(id_sid)
# Print the first 6 rows of id_sid2
head(id_sid2)
```

```{r ReadData pt_acuity}
# ----- `pt_acuity` -----
# 1e. read "ACUITY-patients.xlsx
pt_acuity <- read_xlsx(paste0(data_path, "Data_Files/ACUITY-patients.xlsx"))
# str(pt_acuity)
pt_acuity_s2 <- read_xlsx(paste0(data_path, "Data_Files/ACUITY-patients.xlsx"), sheet = 2)
# str(pt_acuity_s2)
pt_acuity_s3 <- read_xlsx(paste0(data_path, "Data_Files/ACUITY-patients.xlsx"), sheet = 3)
# str(pt_acuity_s3)
```

```{r CleanData pt_acuity, eval = FALSE}
# Patient acuity (Emergency Severity Index; ESI) counts by shift
head(pt_acuity)
# Pivot_wider to view number of patients in each ESI category by shift
pt_acuity %>% 
  group_by(Acuity) %>% 
  count(Shift) %>% 
  pivot_wider(names_from = Acuity, values_from = n) %>% 
  head()
# Print the first 6 rows of the other two sheets in the xlsx file
head(pt_acuity_s2)
head(pt_acuity_s3)
```




### RFID Badge & Location Data  
"Cpat.zip" and "Cstaff.zip" contain "completepat.sas7bdat" and "completestaff.sas7bdat," respectively, that contain location information for patients and staff from all observed shifts, respectively.
* Both completeXXX.sas7bdat tables have columns for every second of the day, named with the prefix "floc" followed by the second
* Each row contains the locations (numeric values) for the respective SID and date combination
  +   Some patient SIDs repeat in the data because RFID tags were used by more than one patient per shift
  +   Staff had permanent tags, so SID numbers were not duplicated  
* Room locations with square footage are in an Excel file, which links location numbers to location names  

Columns (i.e., variables), variable classes, and variables definitions in 'completepat.sas7bdat'  
| Variable | Class | Definition |  
|----------|-------|------------|  
| SID | char | individual RFID badge number |  
| date | char | date observation started |  

Columns (i.e., variables), variable classes, and variables definitions in 'completestaff.sas7bdat'  
| Variable | Class | Definition |  
|----------|-------|------------|  
| SID | char | individual RFID badge number |  
| date | char | date observation started |  
  
