---
title: "Network Analysis of Clinical Interactions (NACI): Data Cleaning Log"
output: html_notebook
---
# Versioning & Setup  

```{r setup, include=FALSE, tidy=TRUE, warning=FALSE, message=FALSE, echo=FALSE}
# This is an example setup chunk from the N741 project
# knitr::opts_chunk$set(echo = FALSE, tidy=TRUE, warning=FALSE, message=FALSE)
library(igraph)
library(haven)
library(tidyverse)
library(lubridate)
library(pander)
library(printr)
library(forcats)
library(modelr)
# options(na.action = na.warn)
```



```{r data import}
# read in the edges
# edges <- haven::read_sas("tommy_edges_2009.sas7bdat") 
# read in the node traits: nodes
# nodes <- haven::read_sas("tommy_nodes_2009.sas7bdat")
# read in patient characteristics data: patients
# patients <- haven::read_sas("tommyflynn_patient_info_2009.sas7bdat")

```

```{r Date Fix}
# There is an issue with dates; each dataset has a different set of dates; figure out what dates to use with:
PTS_d8s <- unique(patients$d8) 
Nodes_d8s <-  unique(nodes$d8)
Edges_D8s <-  unique(edges$D8)
alldates <- c(PTS_d8s, Nodes_d8s , Edges_D8s)
# length(alldates) answer= 131
alldates <- unique(alldates) # There are 49 total unique dates across all three tbls, but only 35 in edges!
```

```{r Chief Complaint Levels}
# Chief complaint is a string with more than 300 variables (mostly referring to the same short-list of complaints (i.e. many duplicates)). Re-level with fct_collapse() in a mutate() call.

patients_cc <- patients %>% mutate(CC_group = fct_collapse(Chief_Complaint,
                                            Pain_Abd = c("Pain, Abd General", "Abdominal pain",
                                                         "Abdominal pain - pregnant", "Abdominal problem",
                                                         "Pain, Abd LLQ", "Nausea/Vomiting with Abd Pain",
                                                         "Flank Pain", "Pain, Abd RLQ", "Pain, Epigastric",
                                                         "Pain, Flank", "Preg w/ Abd Pain", "Pain, Abd RUQ",
                                                         "Flank pain", "Pain, Abd LUQ"),
                                            Pain_Chest = c("Chest Pain", "Chest pain", "Pain, Chest", 
                                                           "Chest Pressure", "Chest Wall Pain", 
                                                           "Heartburn or indigestion",
                                                           "Pain, Chest/Ribs", "Pain, Rib(s)"),
                                            Resp_ARDS = c("Dyspnea", "Difficulty Breathing", "Asthma", 
                                                          "Respiratory problem", "Wheezing", 
                                                          "Exposure, Chemical, Inhalation"),
                                            Pain_MSK = c("Back Pain", "Pain, Knee", "Pain, Leg", 
                                                         "Pain, Ankle", 
                                                         "Pain, Arm", "Pain, Back", "Pain, Foot", 
                                                         "Pain, Hip", 
                                                         "Pain, Other", "Body aches (general)", 
                                                         "Knee pain - swelling", 
                                                         "Pain, Shoulder", "Pain, Neck", 
                                                         "Back pain - lumbar", 
                                                         "Leg pain - swelling", "Pain, Hand", 
                                                         "Arm pain - swelling",
                                                         "Foot pain - swelling", "Pain, Low Back", 
                                                         "Pain, Wrist", 
                                                         "Shoulder pain - swelling", 
                                                         "Ankle pain - swelling",
                                                         "Elbow pain - swelling", 
                                                         "Hip pain - swelling", "Neck pain",
                                                         "Pain, Breast", "Pain, Buttocks", "Pain, Finger", 
                                                         "Pain, Forearm",
                                                         "Pain, Joints, Multiple", "Pain, Muscular General",
                                                         "Pain, Toe",
                                                         "Back pain - thoracic", "Facial pain", 
                                                         "Hand pain - swelling", 
                                                         "Lower leg pain - swelling", "Pain, Face", 
                                                         "Pain, Heel",
                                                         "Multiple musculoskeletal pain/swelling", 
                                                         "Pain, Generalized", 
                                                         "Rib/Trunk pain - swelling", 
                                                         "Wrist pain - swelling", 
                                                         "Finger(s) pain - swelling", "Preg w/ Back Pain"),
                                            Neuro_HA = c("Headache", "Headache, Migraine Hx", 
                                                         "Headache - recurrent",
                                                         "Headache, Cluster Hx", 
                                                         "Headache, New, No Prior Hx", 
                                                         "Headache, Post Traumatic", "Pain, Head"),
                                            Resp_Inf = c("Flu Symptoms", "Cough", "Sore Throat", "URI Sxs", 
                                                         "Cough, Productive", "Throat pain", 
                                                         "Cough, Cold, Congestion",
                                                         "Cold Symptoms", "Congestion", 
                                                         "Upper respiratory infection",
                                                         "Cough, Non Productive"),
                                            Other = c("Multiple Complaints", "AICD discharge", 
                                                      "Medical Problem - Minor", "Other Complaint", 
                                                      "Sweats", "Medical Problem - Minor", "Hiccoughs",
                                                      "Choking", "Cyst", "Gout"),
                                            Neuro_AMS = c("Dizzy", "Syncope", "Altered Mental Status", 
                                                          "Dizziness", 
                                                          "Altered mental status", "Seizure, Epilepsy Hx",
                                                          "Fatigue",
                                                          "Seizure, Non Specific", "Neurological problem",
                                                          "Near Syncope",
                                                          "Seizure, New Onset", "Difficulty Speaking", 
                                                          "Confusion", "Fainting", "Seizure", 
                                                          "Seizure - prior history", 
                                                          "Vertigo", "Vision Loss or Disturbance"),
                                            GI_General = c("Vomiting", "Bleeding, Rectal",
                                                           "Nausea/Vomiting/Diarrhea", 
                                                         "Nausea/Vomiting", "Diarrhea", "Nausea", 
                                                         "GI bleed",
                                                         "Constipation", "Nausea/Vomiting/ Abd Pain",
                                                         "Dehydration", 
                                                         "Rectal pain", "FB, Rectum", "Hemorrhoids",
                                                         "Hernia, Abd",
                                                         "Hernia, Other", "Loss of Appetite", 
                                                         "Failure to Thrive",
                                                         "Pain, Hemorroids", "Preg w/ Epigastric Pain", 
                                                         "Preg w/ Nausea,Vomiting &lt; 20 wks",
                                                         "Regurgitation", 
                                                         "Vomiting - pregnant"),
                                            GU = c("Bleeding, Vaginal", "Vaginal Discharge", 
                                                   "Urinary Retention", 
                                                   "Urinary Burning", "Pain, Pelvic", 
                                                   "Pelvic pain &lt; 20 weeks pregnant",
                                                   "Preg, Vag Bleed, &lt; 20 wks", "Dysuria", "Hematuria",
                                                   "Pelvic pain",
                                                   "STD exposure", "Vaginal bleed", 
                                                   "Vaginal discharge/Itching", 
                                                   "Dysuria/Frequency", "Genitourinary problem", 
                                                   "Preg w/ Pelvic Pain",
                                                   "Preg w/ painful vaginal bleeding", "STD Exposure",
                                                   "Vaginal pain",
                                                   "Vaginal bleed &lt; 20 weeks pregnant", "FB, Vagina",
                                                   "Groin pain", 
                                                   "Incontinent, Urine", "Pain, Groin", "Penile Discharge",
                                                   "Preg w/ Vag D/C", "Preg w/ Vag Pain", 
                                                   "Preg, Poss Spont Abortion",
                                                   "Preg, Possible", "Testicular pain", "Urinary Frequency",
                                                   "Urinary Hesitancy", "STD, Possible"),
                                            Weakness_Numbness = c("Weakness, Generalized", 
                                                          "Weakness, All Extremities", 
                                                         "Weakness or fatigue", "Focal motor weakness",
                                                         "Weakness, One Side Body", "Numbness, Arm(s)", 
                                                         "Numbness, One Side Body", "Numbness, Face", 
                                                         "Numbness, Hand(s)/Finger(s)", "Numbness, Other",
                                                         "Weakness, Face",
                                                         "Weakness, Lower Ext", "Weakness, Other", 
                                                         "Weakness, Upper Ext"),
                                            MVC = c("Motor Vehicle Crash", "MVC - Minor", 
                                                    "Auto-Pedest Crash"),
                                            Fall = c("Fall", "Fall, ground level"),
                                            Swelling = c("Swelling, Leg", "Swelling, Face", 
                                                         "Edema, Lower Ext",
                                                         "Swelling, Hand", "Swelling, Knee", 
                                                         "Swelling, Neck", "Edema, Other",
                                                         "Swelling, Abd", "Swelling, Arm", "Swelling, Eye", 
                                                         "Swelling, Foot",
                                                         "Swollen Glands Other", "Leg edema", 
                                                         "Swelling, Airway", "Abnormal diagnostic test",
                                                         "Swelling, General", "Swelling, Ankle"),
                                            Glycemias = c("Hyperglycemia", "Hypoglycemia", 
                                                          "Diabetes Mellitus, IDDM"),
                                            Heme_HgSS = c("Sickle Cell crisis", "Sickle Cell, Pain", 
                                                          "Sickle Cell, Joint Pain",
                                                          "Sickle Cell, Chest Pain", "Sickle Cell, Other"),
                                            Allergic_Rx = c("Allergic Reaction", 
                                                            "Allergic reaction - minor", 
                                                           "Allergic reaction - major", 
                                                           "Medication Reaction"),
                                            Follow_Up = c("Surgical Problem Re-evaluation", 
                                                          "Medical Clearance",
                                                          "Infection, Incision", "Lab draw", 
                                                          "Medication refill", 
                                                          "Suture Removal", "Abnormal diagnostic test",
                                                          "Surgical problem re-evaluation",
                                                          "Wound, Dehiscence", "Wound, Re-eval", 
                                                          "Supplies Only", "Lab or Test Abnormality",
                                                          "Medical problem re-evaluation", 
                                                          "Disloc Hip, Prior Replace"),
                                            Chronic = c( "Catheter check or insertion", 
                                                         "Dialysis shunt problem", 
                                                         "Dialysis Access Problem", "Cancer", 
                                                         "Pacemaker Problem",
                                                         "Dialysis Prob, Hemodialysis Access", 
                                                         "Dialysis Prob, Hemodialysis Graft", 
                                                         "GI tube evaluation", 
                                                         "ICD Related Problem", 
                                                         "Indwelling line problem",
                                                         "PEG Tube Problem", "PICC Line Problem"),
                                            Behavioral = c("Suicidal", "Anxiety/Anxious", 
                                                           "Alcohol Intoxication Possible",
                                                           "Alcohol Related Problem", "Depression", 
                                                           "Psych, Anxiety/Anxious",
                                                           "Suicidal ideation", "Anxiety", 
                                                           "Detox Requested", "Suicide Attempt", 
                                                           "Suicidal Ideation", "Withdrawal, Alcohol",
                                                           "Psychiatric problem", 
                                                           "Psych, Behavior Disorder"),
                                            Injury = c("Assault, Physical", "Sexual assault", "Lac, Finger",
                                                       "Bleeding, Other", "Lac, Leg", "Inj, Finger(s)",
                                                       "Lac, Hand", "Hip injury - minor", "Inj, Arm",
                                                       "Inj, Hand(s)", "Inj, Leg", "Inj, Head", 
                                                       "Inj, Wrist", "Lac, Arm", "Assault, Sexual",
                                                       "Lac, Face", "Lac, Forehead", "Lac, Scalp", 
                                                       "Facial injury - minor", "Extremity injury - minor",
                                                       "Inj, Ankle", "Inj, Hip", "Lac, Chin",
                                                       "Knee injury - minor", "Lac, Eyelid", "Lac, Foot",
                                                       "Lac, Lip", "Laceration - facial", 
                                                       "Laceration - finger", "Laceration - scalp",
                                                       "Laceration - facial", "Laceration - finger",
                                                       "Laceration - scalp",
                                                       "Puncture Wound", "Shoulder injury - minor", 
                                                       "Wrist injury - minor",
                                                       "Hand injury - major", "Arm injury - minor",
                                                       "Abrasion minor", 
                                                       "Abrasion, Abd", "Bite, Insect", "Bite, Dog", 
                                                       "Bite, Human", 
                                                       "Bite, Spider", "Bite, Animal", 
                                                       "Bite, Unknown", "Sting, Insect"),
                                            HEENT_oral = c("Eye(s), Complaint, Other", "Pain, Ear",
                                                           "Earache", "Nosebleed", 
                                                      "ENT problem", "Pain, Eye", "Pain, Dental", 
                                                      "Pain, Oral", "Eye pain",
                                                      "Swallowing Problem", "Ear Discharge", "Epistaxis", 
                                                      "Ear pain", 
                                                      "Eye(s), Swollen", "Hemoptysis", "Dental pain", 
                                                      "Difficulty swallowing",
                                                      "Ear Wax", "Eye foreign body", "Eye(s), Irritation", 
                                                      "FB, Throat", 
                                                      "Nasal drainage", "Tongue swelling"),
                                            CV_Sxs = c("Hypertension", "Hypotension", "Tachycardia", 
                                                       "Heartbeat, Palpitations",
                                                       "Palpitations", "Heartbeat, Irregular", 
                                                       "Bradycardia", 
                                                       "Heartbeat, Racing"),
                                            Fever = c("Fever, Pediatric", "Fever, Adult", "Fever",
                                                       "Chills", "Fever, Immunocompromised"),
                                           Skin_Wnd_Absc = c("Rash", "Itching", "Sores, Skin", 
                                                     "Burn, Thermal","Abscess - complicated", 
                                                     "Abscess - simple", "Abscess Skin/Soft Tissue", 
                                                     "Infection, Skin/Soft Tissue, Other", "Jaundice",
                                                     "Burn, Chemical", "Infection, Hand/Finger",
                                                     "Infection, Other", "Poison Ivy/Poison Oak", 
                                                     "Rash, Possible Allergy", 
                                                     "Wound infection (complicated)",
                                                     "Skin lesion bleed", "Skin problem", "Leg ulcers", 
                                                     "Ulcer, Lower Extremity", 
                                                     "Infection, Rectal/Perirectal" ),
                                            Emergent = c("Medical Problem - Major", "Wound, Gunshot", 
                                                       "Cardiac and/or respiratory arrest")
                                            
))
```

```{r Tidy Data}
# names(nodes)
# Now clean the patients data to include: acuity recorded, race black or white, date in edges, chief complaint, MinutesInED, 
patients35 <- patients_cc %>% filter(Acuity != "Not Recorded", !is.na(Acuity), Race != "2") %>% 
  mutate(Race = as.factor(Race), Acuity = as.factor(Acuity), Sex = as.factor(Sex)) %>%
  select(sid, d8, Acuity, Race, AGE, Sex, Chief_Complaint, CC_group, MinutesInED, ED_ARRIVAL, 
         ed_departure, Arr_Mode, ED_Disposition, numshift)
# head(patients)
# Now tidy Edges, select only the needed variables (sidi, sidj, participant type i-j, date, am, pm, 
# weight); remove all edges between two patients

edges35 <- edges %>% filter(!is.na(i_participant_type), !is.na(j_participant_type), !is.na(i), !is.na(j),
                            (i_participant_type  != "_PAT" | j_participant_type != "_PAT" )) %>%
  mutate(i = i_participant_type, j = j_participant_type, am = (shiftampm == 1), 
         pm = (shiftampm == 2)) %>%
  select(sidi, sidj, i, j, edgeweight, am, pm, D8, idi, idj, numshift)

# Alright; lets get to the nodes.. need to have the ID come first...
nodes35 <- nodes %>% filter(Race != "2") %>%
  mutate(ID = as.character(ID), i = as.character(i), AGE = as.integer(AGE), Acuity = as.factor(Acuity), 
                            Race = as.factor(Race), Sex = as.factor(Sex)) %>%
  select(sid, i, d8, ID, participant_type, AGE, Race, Sex, Acuity, Arr_Mode, shift_num,
         MinutesInED,  duration_observed, shift_ampm, ED_Disposition, BLACKyn, participationrate)
```


```{r Participants}
# patient demographics
# Race stats
racedf <- data_frame("Race" = c("Black", "Hispanic", "Other", "White"), "Count" = summary(patients35$Race))
race_table <- knitr::kable(racedf, align = "l", caption = "Patient Race",
             row.names = FALSE)
race_plot <- ggplot(patients35, aes(x = AGE)) + geom_histogram() + 
  scale_x_continuous("Patient Age Distribution") + 
  labs(title = "Distribution of Patient Age")
# Acuity stats
acuitydf <- data_frame("Acuity Level" = c("Immediate (1)", "Emergent (2)", "Urgent (3)", "Stable (4)", "Non Urgent (5)"),
                       "Count" = summary(patients35$Acuity))
acuity_table <- knitr::kable(acuitydf, align = "l", caption = "Patient Acuity",
             row.names = FALSE)
acuity_ploot <- ggplot(patients35, aes(x = Acuity, fill = Acuity)) + geom_bar(position = "dodge") + 
  scale_x_discrete("Patient Acuity") + labs(title = "Distribution of Patient Acuity")
# Gender Stats
gender <- data_frame("Sex" = c("Female", "Male"), "Count" = summary(patients35$Sex))
gender_table <- knitr::kable(gender, align = "l", caption = "Patient Gender",
             row.names = FALSE)
# Age stats
mean_age <- patients35 %>% summarise(Age_mean = mean(AGE, na.rm=TRUE), sd = sd(AGE, na.rm=TRUE))
mean_age <- knitr::kable(mean_age, align = "l", caption = "Patient Age",
             row.names = FALSE)
age_distribution <- ggplot(patients35, aes(x = AGE)) + geom_histogram(fill = "orange", alpha = .5) + 
  scale_x_continuous() + 
  labs(title = "Distribution of Patient Age", y = "Count", x = "Patient Age")
# now let's see if this works... finally
participants <- nodes35 %>% summarise(n = n_distinct(ID), shifts = n_distinct(shift_num), meanparts = n/35,
                                  participation = mean(participationrate), ties = length(edges35$sidi), 
                                 tieshifts = ties/35)
headers <- c("Participants (n)", "Shifts", "Participants/Shift", "Participation Rate (mean%)", "Total Ties",
            "Ties/Shift")
participants <- knitr::kable(participants, align = "c", caption = "Overall Participation", 
             col.names = headers, row.names = FALSE)
# Chief Complaints
CC_graph <- ggplot(patients35, aes(x = Chief_Complaint, fct_reorder(CC_group, MinutesInED), 
                                   color = Acuity)) + geom_count() + theme(legend.position = "right")
```

```{r Unused Plots, eval=FALSE, include=FALSE}
ccgrou_plot <- ggplot(patients35, aes(AGE, fct_reorder(CC_group, MinutesInED), color = Acuity)) +
         geom_count(position = "jitter", alpha = 0.6, shape = 1, size = 4) +
         scale_x_continuous("Patient Age (yrs)", limits = c(1, 100)) + 
         scale_y_discrete(name = "Chief Complaint")
disposition_plot <- ggplot(patients35, aes(ED_Disposition)) + geom_bar() + 
  scale_x_discrete("ED Disposition")
```

# RTLS Data

This study applies a secondary data analysis design due to the exploritory nature of the research aims. Data was made available with permissions from the originating research team. The purpose of the original study was to describe contact characteristics between patients and staff in the ED of a busy urban hospital to inform cross-infection control measures. Data were collected using a radio-frequency identification system that triangulated patient and staff (nurses, providers, and ancillary staff) locations within the ED at Emory University Hospital Midtwon. Data for this secondary analysis were collected using a prospective, longitudinal, observational design with a random sampling of one day shift and one night shift per week for one year, July 1, 2009 to June 30, 2010. This strategy was chosen to minimize sampling bias related to seasonal or weekly fluctuations in census, acuity, and ED staffing changes. Although a total of 104 shifts were observed, the original research team retained only 81 shifts for reasons related to issues with the RFID system and study staff sick leave [@RN1X]. 

Analysis Plan
=============

# Data Exploration & Cleaning
Code for analyses were maintained in private repositories in the GitHub version control platform. Patient characteristic data was evaluated for missing or implausible data with discriptive analyses, and RFID generated networks will be included for statistical analysis if variables of network density, centrality, and a network diversity scale are distributed normally across networks. 
The data were inconsitant in the way individual participants were tagged. There were `length(unique(nodes$sid))` unique nodes in the vertices data, `length(unique(edges$sidi))` unique nodes in the edges dataset, and `length(unique(patients$sid))` unique patients in the patient characteristics dataset. Furthermore, there were a number of extra dates of data collection in the nodes and patients data. After learning several new tricks, the data were finally subsetted into 35 data frames to be graphed with iGraph.[@IGRAPH] 
```{r 35 igraphs}
# Edges by shift... this could have been easier; but I spent too much time working my way through the data already; no time to learn how to write a function or loop... :(

# Edges by shift... this could have been easier; but I spent too much time working my way through the data already; no time to learn how to write a function or loop... :(
Eshift1 <- edges35 %>% filter(D8 == Edges_D8s[1])
Eshift2 <- edges35 %>% filter(D8 == Edges_D8s[2])
Eshift3 <- edges35 %>% filter(D8 == Edges_D8s[3])
Eshift4 <- edges35 %>% filter(D8 == Edges_D8s[4])
Eshift5 <- edges35 %>% filter(D8 == Edges_D8s[5])
Eshift6 <- edges35 %>% filter(D8 == Edges_D8s[6])
Eshift7 <- edges35 %>% filter(D8 == Edges_D8s[7])
Eshift8 <- edges35 %>% filter(D8 == Edges_D8s[8])
Eshift9 <- edges35 %>% filter(D8 == Edges_D8s[9])
Eshift10 <- edges35 %>% filter(D8 == Edges_D8s[10])
Eshift11 <- edges35 %>% filter(D8 == Edges_D8s[11])
Eshift12 <- edges35 %>% filter(D8 == Edges_D8s[12])
Eshift13 <- edges35 %>% filter(D8 == Edges_D8s[13])
Eshift14 <- edges35 %>% filter(D8 == Edges_D8s[14])
Eshift15 <- edges35 %>% filter(D8 == Edges_D8s[15])
Eshift16 <- edges35 %>% filter(D8 == Edges_D8s[16])
Eshift17 <- edges35 %>% filter(D8 == Edges_D8s[17])
Eshift18 <- edges35 %>% filter(D8 == Edges_D8s[18])
Eshift19 <- edges35 %>% filter(D8 == Edges_D8s[19])
Eshift20 <- edges35 %>% filter(D8 == Edges_D8s[20])
Eshift21 <- edges35 %>% filter(D8 == Edges_D8s[21])
Eshift22 <- edges35 %>% filter(D8 == Edges_D8s[22])
Eshift23 <- edges35 %>% filter(D8 == Edges_D8s[23])
Eshift24 <- edges35 %>% filter(D8 == Edges_D8s[24])
Eshift25 <- edges35 %>% filter(D8 == Edges_D8s[25])
Eshift26 <- edges35 %>% filter(D8 == Edges_D8s[26])
Eshift27 <- edges35 %>% filter(D8 == Edges_D8s[27])
Eshift28 <- edges35 %>% filter(D8 == Edges_D8s[28])
Eshift29 <- edges35 %>% filter(D8 == Edges_D8s[29])
Eshift30 <- edges35 %>% filter(D8 == Edges_D8s[30])
Eshift31 <- edges35 %>% filter(D8 == Edges_D8s[31])
Eshift32 <- edges35 %>% filter(D8 == Edges_D8s[32])
Eshift33 <- edges35 %>% filter(D8 == Edges_D8s[33])
Eshift34 <- edges35 %>% filter(D8 == Edges_D8s[34])
Eshift35 <- edges35 %>% filter(D8 == Edges_D8s[35])
# Nodes by shift
Vshift1 <- nodes35 %>% filter(d8 == Edges_D8s[1])
Vshift2 <- nodes35 %>% filter(d8 == Edges_D8s[2])
Vshift3 <- nodes35 %>% filter(d8 == Edges_D8s[3])
Vshift4 <- nodes35 %>% filter(d8 == Edges_D8s[4])
Vshift5 <- nodes35 %>% filter(d8 == Edges_D8s[5])
Vshift6 <- nodes35 %>% filter(d8 == Edges_D8s[6])
Vshift7 <- nodes35 %>% filter(d8 == Edges_D8s[7])
Vshift8 <- nodes35 %>% filter(d8 == Edges_D8s[8])
Vshift9 <- nodes35 %>% filter(d8 == Edges_D8s[9])
Vshift10 <- nodes35 %>% filter(d8 == Edges_D8s[10])
Vshift11 <- nodes35 %>% filter(d8 == Edges_D8s[11])
Vshift12 <- nodes35 %>% filter(d8 == Edges_D8s[12])
Vshift13 <- nodes35 %>% filter(d8 == Edges_D8s[13])
Vshift14 <- nodes35 %>% filter(d8 == Edges_D8s[14])
Vshift15 <- nodes35 %>% filter(d8 == Edges_D8s[15])
Vshift16 <- nodes35 %>% filter(d8 == Edges_D8s[16])
Vshift17 <- nodes35 %>% filter(d8 == Edges_D8s[17])
Vshift18 <- nodes35 %>% filter(d8 == Edges_D8s[18])
Vshift19 <- nodes35 %>% filter(d8 == Edges_D8s[19])
Vshift20 <- nodes35 %>% filter(d8 == Edges_D8s[20])
Vshift21 <- nodes35 %>% filter(d8 == Edges_D8s[21])
Vshift22 <- nodes35 %>% filter(d8 == Edges_D8s[22])
Vshift23 <- nodes35 %>% filter(d8 == Edges_D8s[23])
Vshift24 <- nodes35 %>% filter(d8 == Edges_D8s[24])
Vshift25 <- nodes35 %>% filter(d8 == Edges_D8s[25])
Vshift26 <- nodes35 %>% filter(d8 == Edges_D8s[26])
Vshift27 <- nodes35 %>% filter(d8 == Edges_D8s[27])
Vshift28 <- nodes35 %>% filter(d8 == Edges_D8s[28])
Vshift29 <- nodes35 %>% filter(d8 == Edges_D8s[29])
Vshift30 <- nodes35 %>% filter(d8 == Edges_D8s[30])
Vshift31 <- nodes35 %>% filter(d8 == Edges_D8s[31])
Vshift33 <- nodes35 %>% filter(d8 == Edges_D8s[33])
Vshift34 <- nodes35 %>% filter(d8 == Edges_D8s[34])
Vshift35 <- nodes35 %>% filter(d8 == Edges_D8s[35])
```

##Analysis
The open-source R statistical language and R-Studio user interface from the developers at CRAN were used for all data exploration, wrangling, cleaning, description, and analysis.[@CRAN] Pandoc's Markdown allows for seemless integration of code, results, visualizations, and author interpretation of the research into a single document.[@MARKDOWN] Running all code and calculating all results within the menuscript itself, Markdown eliminates risk for errors in transferring statistical software output into foreign documents. The data were explored, cleaned, and assessed for statistical assumptions using the Tidyverse group of R packages.[@TIDY, @GGPLOT2] Data were prepared for network visualization and plotted with the network object package iGraph. [@IGRAPH].


Results
=======
`participants`  `acuity_table`
The bulk of this project ended up focussing on data exploration and wrangling. Although the data came in tables that had been _cleaned_, there turned out to be a significant amount of wrangling and organizing to re-clean it for the purposes of this study. 
 

```{r relationships, message=FALSE}
# Plot acuity by different degree measures
acuityEIGEN <- nodes %>% filter(participant_type == "_PAT", Acuity != "Not Recorded") %>%
  ggplot(aes(x = Acuity, y = Eigenvector_Centrality, color = Acuity)) + 
  geom_boxplot(shape = 1)
acuitybyWTDEG <- nodes %>% filter(participant_type == "_PAT", Acuity != "Not Recorded") %>%
  ggplot(aes(x = LOG_WTDEGREE, y = Acuity, color = Acuity)) + 
  geom_boxplot(shape = 1)

```

We selected 3 representative shifts for visualization and exploration. Although I was not able to analyze these networks to the extent I had hoped, there are a number of visualizations shown below.
The first shift represented below shows an interesting cluster of highly acute (gray) patients, indicating that there may be something to the hypothesis that acuity will correlate to network position.
```{r shift 10, warning=FALSE, message=FALSE}
# head(Eshift1)
# head(Vshift1)
# similar <- Eshift1$sidi %in% Vshift1$sid
# table(similar)
# similar2 <- Eshift1$idi %in% Vshift1$ID
# table(similar2)
Vshift10 %>% mutate(Acuity = as.factor(Acuity)) -> Vshift10
shift10 <- graph_from_data_frame(d = Eshift10, directed = FALSE, vertices = Vshift10)
V(shift10)$label <- Vshift10$participant_type
V(shift10)$gender <- Vshift10$Sex
E(shift10)$weight <- Eshift10$edgeweight
V(shift10)$acuity <- Vshift10$Acuity
# set vertex attributes(shift10)
# vertex color
colrs <- c("gray50", "blue", "gold", "tomato", "white")
V(shift10)$color <- colrs[V(shift10)$acuity]
# Vertex size [add when centrality is calculated]
# V(shift10)$size <- V(shift10)$MinutesInED
# EDge width
E(shift10)$width <- E(shift10)$weight*2
# Set edge color (optional)
E(shift10)$edge.color <- "black"
plot(shift10, vertex.label.dist=2)
legend(x=-1.5, y=-1.1, c("Immediate(1)", "Emergent(2)", "Urgent(3)", "Stable(4)", "Non Urgent(5)"), pch=21,
       col="#777777", pt.bg=colrs, pt.cex=2, cex=.8, bty="n", ncol=1)
```

The graph below is does not display the individual patient acuities, but it does give a slightly better overview of the various positions of patients, staff, RNs, & MDs thoughout the network. 

```{r shift10 labels}
plot(shift10, vertex.shape="none", vertex.label=V(shift10)$label, 
     vertex.label.font=2, vertex.label.color="black", vertex.label.cex=.7, edge.color="gray85")
```

The following network offers a unique perspective of the distribution of ties in the network by essentially _getting the nodes out of the way_. What is particularly interesting is teh way the ties appear to be more dense where patients are scored at an acuity of level 1, or "Immediate". A closer look at the distribution of edges may provide further insights in following analyses. 
```{r shift10 circle}
l <- layout_in_circle(shift10)

plot(shift10, layout=l, vertex.label.dist = 2)
```

```{r Shift10 4x4, eval=FALSE}

fr <- layout_with_fr(shift10)
fr <- norm_coords(fr, ymin=-1, ymax=1, xmin=-1, xmax=1)
par(mfrow=c(2,2), mar=c(0,0,0,0))
plot(shift10, rescale=F, layout=fr*0.4)
plot(shift10, rescale=F, layout=fr*0.6)
plot(shift10, rescale=F, layout=fr*0.8)
plot(shift10, rescale=F, layout=fr*1.0)



# plot(shift10, vertex.label.dist = 2, layout = fr)
# legend(x=-1.5, y=-1.1, c("Imediate", "Emergent", "Urgent", "Stable", "Non Urgent"), pch=21,
       # col="#777777", pt.bg=colrs, pt.cex=2, cex=.8, bty="n", ncol=1)
# Eshift1$i=="_PAT"
```

The remaining graphs are generated from two other shifts. Although much of the overall visual characteristics appear similar, there are a number of interesting differences that have given me ideas for further inquiry. 
```{r shift 23}
Vshift23 %>% mutate(Acuity = as.factor(Acuity)) ->Vshift23
shift23 <- graph_from_data_frame(d = Eshift23, directed = FALSE, vertices = Vshift23)
V(shift23)$label <- Vshift23$participant_type
V(shift23)$gender <- Vshift23$Sex
E(shift23)$weight <- Eshift23$edgeweight
V(shift23)$acuity <- Vshift23$Acuity
# set vertex attributes(shift10)
# vertex color
colrs <- c("gray50", "blue", "gold", "tomato", "white")
V(shift23)$color <- colrs[V(shift23)$acuity]
# Vertex size [add when centrality is calculated]
# V(shift10)$size <- V(shift10)$MinutesInED


# EDge width
E(shift23)$width <- E(shift23)$weight*2

# Set edge color (optional)
E(shift23)$edge.color <- "black"



plot(shift23, vertex.label.dist=2)
legend(x=-1.5, y=-1.1, c("Immediate(1)", "Emergent(2)", "Urgent(3)", "Stable(4)", "Non Urgent(5)"), pch=21,
       col="#777777", pt.bg=colrs, pt.cex=2, cex=.8, bty="n", ncol=1)


```
As I am able to code more complex data and create better network graphs, and analyze the structure of those graphs, this project will guide research questions.
```{r shift23 }
layouts <- grep("^layout_", ls("package:igraph"), value=TRUE)[-1] 

# Remove layouts that do not apply to our graph.

layouts <- layouts[!grepl("bipartite|merge|norm|sugiyama|tree", layouts)]

par(mfrow=c(3,3), mar=c(1,1,1,1))

for (layout in layouts) {

  l <- do.call(layout, list(shift23)) 
  
  plot(shift23, edge.arrow.mode=0, layout=l, main=layout) }
```


```{r shift13}
Vshift13 %>% mutate(Acuity = as.factor(Acuity)) -> Vshift13
shift13 <- graph_from_data_frame(d = Eshift13, directed = FALSE, vertices = Vshift13)
V(shift13)$label <- Vshift13$participant_type
V(shift13)$gender <- Vshift13$Sex
E(shift13)$weight <- Eshift13$edgeweight
V(shift13)$acuity <- Vshift13$Acuity
# set vertex attributes(shift10)
# vertex color
colrs <- c("gray50", "blue", "gold", "tomato", "white")
V(shift13)$color <- colrs[V(shift13)$acuity]
# Vertex size [add when centrality is calculated]
# V(shift10)$size <- V(shift10)$MinutesInED
# EDge width
E(shift13)$width <- E(shift13)$weight*2
# Set edge color (optional)
E(shift13)$edge.color <- "black"
num13 <- plot(shift13, vertex.label.dist=2)
  legend(x=-1.5, y=-1.1, c("Immediate(1)", "Emergent(2)", "Urgent(3)", "Stable(4)", 
                           "Non Urgent(5)"), pch=21,
       col="#777777", pt.bg=colrs, pt.cex=2, cex=.8, bty="n", ncol=1)
```

```{r}
layouts <- grep("^layout_", ls("package:igraph"), value=TRUE)[-1] 

# Remove layouts that do not apply to our graph.

layouts <- layouts[!grepl("bipartite|merge|norm|sugiyama|tree", layouts)]


par(mfrow=c(3,3), mar=c(1,1,1,1))

for (layout in layouts) {

  l <- do.call(layout, list(shift13)) 
  
  plot(shift13, edge.arrow.mode=0, layout=l, main=layout) }
```
